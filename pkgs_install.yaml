---
 - hosts: tendrl-api-host
   user: root
   tasks:
    - name: copy tendrl release repo file
      copy:
        src=~/automake/config/tendrl-release-epel-7.repo
        dest=/etc/yum.repos.d/tendrl-release-epel-7.repo force=no

    - name: copy tendrl dependencies repo file
      copy:
        src=~/automake/config/tendrl-dependencies-epel-7.repo
        dest=/etc/yum.repos.d/tendrl-dependencies-epel-7.repo force=no

    - name: installing epel-release
      action:
        yum
          name=epel-release
          state=installed

    - name: installing etcd
      action:
        yum
          name=etcd
          state=installed

    - name: configureing etcd listen clients
      lineinfile:
          dest=/etc/etcd/etcd.conf
          backrefs=yes
          regexp='^#ETCD_LISTEN_CLIENT_URLS='
          line='ETCD_LISTEN_CLIENT_URLS="{{inventory_hostname}}:2379"'

    - name: configureing etcd send clinets
      lineinfile:
          dest=/etc/etcd/etcd.conf
          backrefs=yes
          regexp='^#ETCD_ADVERTISE_CLIENT_URLS*'
          line='ETCD_ADVERTISE_CLIENT_URLS="{{inventory_hostname}}:2379"'

    - name: installing tendrl-api
      action:
        yum
          name=tendrl-api
          state=installed

    - name: copy tendrl-api configuration
      copy:
        src=~/automake/config/etcd.yml
        dest=/etc/tendrl/etcd.yml force=yes

    - name: Update package "api" to latest version
      yum:
        name: tendrl-api
        state: latest

    - name: Update package "commons" to latest version
      yum:
        name: tendrl-commons
        state: latest

    - name: Update package "node-agent" to latest version
      yum:
        name: tendrl-node-agent
        state: latest

    - name: Put SELinux in permissive mode
      selinux:
        policy: targeted
        state: permissive

    - name: Disable SELinux
      selinux:
        state: disabled

    - name: Restart httpd service
      service:
        name: etcd
        state: restarted

    - name: Restart httpd service
      service:
        name: httpd
        state: restarted
